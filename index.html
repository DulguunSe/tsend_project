<!doctype html>
<html lang="mn">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Бодлийн хөтөч - Сэтгэлзүйн Цаг Товлох</title>
  <meta name="description" content="Сэтгэлзүйн зөвлөгөө, нийтлэл болон цахим цаг товлолын систем" />
  <link rel="stylesheet" href="./style.css">

  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    input[type="date"]:invalid {
      border-color: #d1d5db;
      background-color: #f3f4f6;
      color: #9ca3af;
    }

    .swiper {
      padding-bottom: 20px;
    }

    .swiper-slide {
      width: "300px";
    }

    .time-slot.active {
      background-color: #2563eb;
      color: white;
    }

    .time-slot {
      display: inline-block;
      padding: 6px 12px;
      border: 1px solid #2563eb;
      border-radius: 6px;
      margin: 4px;
      cursor: pointer;
    }

    /* ✅ Toast animation style */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background-color: #16a34a;
      color: white;
      padding: 16px 28px;
      border-radius: 8px;
      font-size: 18px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      opacity: 0;
      z-index: 9999;
      transition: all 0.4s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo"><img src="./img/indra_logo-removebg-preview.png" alt=""></div>
      </div>
      <nav>
        <a class="navlink" href="#articles">Нийтлэл</a>
        <a class="navlink" href="#booking">Цаг товлох</a>
      </nav>
      <div class="hamburger" id="hamburger">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </div>
    </header>

    <div class="mobile-nav" id="mobileNav">
      <a href="#articles">Нийтлэл</a>
      <a href="#booking">Цаг товлох</a>
    </div>

    <section class="hero">
      <h1></h1>
      <p class="lead"></p>
    </section>

    <div class="grid">
      <main>
        <div id="articles" class="card">
          <h2 style="margin-top:0">Нийтлэл</h2>

          <div class="swiper articles" style="margin-top:12px">
            <div class="swiper-wrapper">
              <div class="swiper-slide">
                <div class="article">
                  <img src="./img/download (1).jpeg" alt="">
                  <h3>Өдрийн стрессийг хэрхэн бууруулах вэ</h3>
                  <p>Бага хугацааны амьсгалын дасгал, завсарлага авах, дасгал хөдөлгөөн.</p>
                </div>
              </div>
              <div class="swiper-slide">
                <div class="article">
                  <img src="./img/download.jpeg" alt="">
                  <h3>Хамт олонтой харилцах харилцаа</h3>
                  <p>Санаа бодлоо илэрхийлэх, эвтэй харилцахад туслах 5 алхам.</p>
                </div>
              </div>
            </div>
            <div class="swiper-pagination"></div>
          </div>
        </div>
      </main>

      <aside>
        <div id="booking" class="card booking">
          <h3>Цаг товлох</h3>

          <label for="type">Анги</label>
          <select id="type">
            <option value="1">1 анги</option>
            <option value="2">2 анги</option>
            <option value="3">3 анги</option>
            <option value="4">4 анги</option>
            <option value="5">5 анги</option>
            <option value="6">6 анги</option>
            <option value="7">7 анги</option>
            <option value="8">8 анги</option>
            <option value="9">9 анги</option>
            <option value="10">10 анги</option>
            <option value="11">11 анги</option>
            <option value="12">12 анги</option>
          </select>

          <label for="buleg">Бүлэг</label>
          <select id="buleg">
            <option value="">Бүлэг сонгоно уу</option>
          </select>

          <label for="name">Овог нэр</label>
          <input id="name" type="text" placeholder="Нэр" />

          <label for="email">Утасны дугаар</label>
          <input id="email" type="text" placeholder="88888888" />

          <label for="type-1">Уулзалтын төрөл</label>
          <select id="type-1">
            <option value="Анги хамт олон, гэр бүлтэй холбоотой харилцааны хэлбэр">Анги хамт олон, гэр бүлтэй холбоотой харилцааны хэлбэр</option>
            <option value="Мэргэжил сонголттой холбоотой асуудал">Мэргэжил сонголттой холбоотой асуудал</option>
            <option value="Хүчирхийлэл, дээрэлхэлттэй холбоотой асуудал">Хүчирхийлэл, дээрэлхэлттэй холбоотой асуудал</option>
            <option value="Хорт зуршил, донтолттой холбоотой асуудал">Хорт зуршил, донтолттой холбоотой асуудал</option>
            <option value="Хувь хүний хөгжилтэй холбоотой асуудал">Хувь хүний хөгжилтэй холбоотой асуудал</option>
            <option value="Бусад">Бусад</option>
          </select>

          <label for="date">Огноо</label>
          <input id="date" type="date" />

          <label>Цаг сонгох</label>
          <div class="times" id="quick-times"></div>

          <button id="bookBtn" class="primary">Цаг товлох</button>
          <p id="bookMsg" style="margin-top:8px;color:var(--muted);font-size:13px"></p>
        </div>
      </aside>
    </div>

    <footer>
      <div class="container" style="padding:12px 20px">© <span id="year"></span> Indra cyber school</div>
    </footer>
  </div>

  <!-- ✅ Toast элемент -->
  <div id="successToast" class="toast">✅ Цаг амжилттай захиалагдлаа!</div>


<!-- 
  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="app.js"></script> -->

  <!-- Swiper JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

  <script type="module">
    const gradeToGroups = {
      "1": ["1_1", "1_2", "1_3", "1_4"],
      "2": ["2_1", "2_2"],
      "3": ["3_1", "3_2"],
      "4": ["4_1", "4_2"],
      "5": ["5_1", "5_2"],
      "6": ["6_1", "6_2", "6_3"],
      "7": ["7_1", "7_2"],
      "8": ["8_1"],
      "9": ["9_1"],
      "10": ["10_1", "10_2"],
      "11": ["11_1", "11_2", "11_3"],
      "12": ["12_1"]
    };

    const gradeSelect = document.getElementById('type');
    const groupSelect = document.getElementById('buleg');

    gradeSelect.addEventListener('change', () => {
      const grade = gradeSelect.value;
      const groups = gradeToGroups[grade] || [];
      groupSelect.innerHTML = '<option value="">Бүлэг сонгоно уу</option>';
      groups.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g;
        opt.textContent = g;
        groupSelect.appendChild(opt);
      });
    });

    document.getElementById('year').textContent = new Date().getFullYear();

    document.getElementById('hamburger').addEventListener('click', () => {
      const mobileNav = document.getElementById('mobileNav');
      mobileNav.style.display = mobileNav.style.display === 'flex' ? 'none' : 'flex';
    });

    const swiper = new Swiper(".swiper", {
      slidesPerView: 1.2,
      spaceBetween: 12,
      pagination: { el: ".swiper-pagination", clickable: true },
      breakpoints: { 640: { slidesPerView: 1.5 }, 768: { slidesPerView: 2 }, 1024: { slidesPerView: 2.5 } }
    });

    const firebaseConfig = {
      apiKey: "AIzaSyC2-x9AYrAuUtN3lwSYhV-f-003cTvdP6M",
      authDomain: "indrasetgelzui.firebaseapp.com",
      databaseURL: "https://indrasetgelzui-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "indrasetgelzui",
      storageBucket: "indrasetgelzui.firebasestorage.app",
      messagingSenderId: "546192791621",
      appId: "1:546192791621:web:5485a7ca0ffd6034346b2c",
      measurementId: "G-LRJ7F0V4DT"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const quickTimes = document.getElementById('quick-times');
    document.getElementById('date').addEventListener('input', async (e) => {
      const d = new Date(e.target.value);
      const day = d.getDay();
      let slots = [];
      let activeDay = true;

      if (day === 2) slots = ["10:00", "11:20"];
      else if (day === 3 || day === 5) slots = ["09:00", "10:10", "11:20", "14:00"];
      else activeDay = false;

      quickTimes.innerHTML = '';
      if (!activeDay) {
        quickTimes.innerHTML = `<p style="color:#F7456F">Таны сонгосон өдөр цаг байхгүй байна.</p>`;
        return;
      }

      const snapshot = await db.collection('bookings').where('date', '==', e.target.value).get();
      const bookedTimes = snapshot.docs.map(doc => doc.data().time);

      slots.forEach(t => {
        const div = document.createElement('div');
        div.className = 'time-slot';
        div.textContent = t;
        if (bookedTimes.includes(t)) {
          div.classList.add('disabled');
          div.textContent = `${t} (захиалагдсан)`;
        } else {
          div.onclick = () => {
            document.querySelectorAll('.time-slot').forEach(x => x.classList.remove('active'));
            div.classList.add('active');
          };
        }
        quickTimes.appendChild(div);
      });
    });

   
    document.getElementById('bookBtn').addEventListener('click', async () => {
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('email').value.trim();
  const date = document.getElementById('date').value;
  const grade = document.getElementById('type').value;
  const group = document.getElementById('buleg').value.trim();
  const issue = document.getElementById('type-1').value;
  const selected = document.querySelector('.time-slot.active');
  const msg = document.getElementById('bookMsg');

  if (!name || !phone || !date || !selected) {
    msg.style.color = '#b91c1c';
    msg.textContent = 'Бүх талбаруудыг бөглөнө үү.';
    return;
  }

  const selectedTime = selected.textContent;

  // 🔹 1. Тухайн утасны өмнөх захиалгуудыг шалгана
  const snapshot = await db.collection('bookings')
    .where('phone', '==', phone)
    .get();

  let hasActiveBooking = false;

  snapshot.forEach(doc => {
    const data = doc.data();
    if (!data.date || !data.time) return;

    // Өмнөх захиалгын огноо, цагийг Date болгон хөрвүүлнэ
    const bookingDateTime = new Date(`${data.date}T${data.time}`);
    const now = new Date();

    // Хэрэв өмнөх цаг нь одооноос хойш бол -> идэвхтэй байна гэж үзнэ
    if (bookingDateTime > now) {
      hasActiveBooking = true;
    }
  });

  // 🔹 2. Хэрэв идэвхтэй захиалга байвал
  if (hasActiveBooking) {
    msg.style.color = '#b91c1c';
    msg.textContent = 'Таны өмнөх цагийн захиалга хараахан дуусаагүй байна. Өмнөх цаг өнгөрсний дараа дахин захиална уу.';
    return;
  }

  // 🔹 3. Давхардсан цаг шалгах
  const q = await db.collection('bookings')
    .where('date', '==', date)
    .where('time', '==', selectedTime)
    .get();

  if (!q.empty) {
    msg.style.color = '#b91c1c';
    msg.textContent = 'Энэ цаг аль хэдийн захиалагдсан байна.';
    return;
  }

  // 🔹 4. Firestore-д хадгалах
  try {
    await db.collection('bookings').add({
      name,
      phone,
      grade,
      group,
      issue,
      date,
      time: selectedTime,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // ✅ LocalStorage-д хадгалж success хуудас руу үсэрнэ
    const bookingData = { name, phone, grade, group, issue, date, time: selectedTime };
    localStorage.setItem("latestBooking", JSON.stringify(bookingData));
    window.location.href = "success.html";

  } catch (err) {
    console.error(err);
    msg.style.color = '#b91c1c';
    msg.textContent = 'Алдаа гарлаа. Та дахин оролдоно уу.';
  }
});

  </script>
</body>
</html>
